Menu="DWDVMsettings:1"
Title="DVM Settings"
Tag="wrench"
Markdown="false"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright Mohamed Emad (icon from vnstat-client package)
 * Copyright desertwitch
 *
 * Copyright Dan Landon
 * Copyright Bergware International
 * Copyright Lime Technology
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
?>
<?require_once '/usr/local/emhttp/plugins/dwdvm/include/dwdvm_config.php';?>

<span style="float:right;margin-right:10px"><a href="https://humdi.net/vnstat/" target="_blank" title="DVM User Manual"><i class="fa fa-file-text-o"></i> <u>User Manual</u></a></span>

<div>
    <span class="left"><i class="icon fa fa-power-off"></i> Service Settings</span>
</div>

<br>

<form markdown="0" id="dwdvm-settings" name="dwdvm_settings" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" name="#file" value="dwdvm/dwdvm.cfg">
    <input type="hidden" id="command" name="#command" value="/usr/local/emhttp/plugins/dwdvm/scripts/write_config" />
    
    <dl>
        <dt>DVM Backend:</dt>
        <dd>
	        <strong><?= isset($dwdvm_installed_backend) && $dwdvm_installed_backend ? $dwdvm_installed_backend : "n/a" ?></strong>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>The version of the vnStat backend that is installed on your system.</p>
    </blockquote>

    <dl>
        <dt><strong>Start DVM service:</strong></dt>
        <dd>
            <select id="SERVICE" name="SERVICE" size="1">
                <?=mk_option($dwdvm_service, "disable", "No");?>
                <?=mk_option($dwdvm_service, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>Set to <strong>'Yes'</strong> to start and enable DVM, so that the service will start when the system boots.</p>
        <p>Set to <strong>'No'</strong> to stop and disable DVM, so that the service will not start when the system boots.</p>
    </blockquote>

    <dl>
        <dt>Persist Database on Reboot</dt>
        <dd>
            <select id="BACKUPDB" name="BACKUPDB" class="dwdvm-run" size="1">
                <?=mk_option($dwdvm_backupdb, "disable", "No");?>
                <?=mk_option($dwdvm_backupdb, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>Set to <strong>'Yes'</strong> to make the DVM database persist regular system reboots.</p>
        <p>Set to <strong>'No'</strong> to always start with a fresh DVM database on system reboot.</p>
        <p>In case of a power outage the last available database remaining on the flash drive will be restored (when enabled).</p>
    </blockquote>

    <dl>
        <dt>
            <input id="DEFAULT" type="submit" name="#default" value="Default">
            <input id="RESETCONF" class="dwdvm-run" type="button" value="Reset Config">
            <input id="RESETALL" class="dwdvm-run" type="button" value="Reset All">
        </dt>
        <dd>
            <input type="submit" id="btnApply" name="#apply" value="Apply">
            <input type="button" value="Done" onclick="done()">
            <input id="RESTART" type="button" value="Restart DVM" style="margin-bottom:8px;">
        </dd>
    </dl>
    <br>
    <blockquote class="inline_help">
    <p><strong>Reset Config</strong> will return your DVM configuration to the default state (preserving the database).</p>
    <p><strong>Reset All</strong> will return your DVM configuration and database to the default state.</p>
    <p><strong>Restart DVM</strong> will restart the DVM service.</p>
    </blockquote>

</form>

<div>
    <span class="left"><i class="icon fa fa-cogs"></i> Runtime Settings</span>
</div>

<br>

<form markdown="0" id="dwdvm-display" name="dwdvm_display" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" name="#file" value="dwdvm/dwdvm.cfg">
    <input type="hidden" id="command2" name="#command" value="/usr/local/emhttp/plugins/dwdvm/scripts/write_config" />

    <dl>
        <dt>Primary Network Interface:</dt>
        <dd>
            <input type="text" class="narrow" id="PRIMARY" name="PRIMARY" maxlength="40" value="<?=$dwdvm_primary;?>">
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls what network interface is used for the data volume metrics shown in the dashboard and footer.</p>
    </blockquote>

    <dl>
        <dt>Show Virtual Network Interfaces:</dt>
        <dd>
            <select id="VIFACES" name="VIFACES" size="1">
                <?=mk_option($dwdvm_vifaces, "disable", "No");?>
                <?=mk_option($dwdvm_vifaces, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls if virtual network interfaces should also be displayed on this page.</p>
        <p>By default only physical network interfaces are shown and virtual network interfaces remain hidden.</p>
        <p>Virtual network interfaces are not always monitorable and the data reported for virtual interfaces may be inconsistent.</p>
    </blockquote>

    <dl>
        <dt>Show Data Volume Metrics in Dashboard:</dt>
        <dd>
            <select id="DASHB" name="DASHB" size="1">
                <?=mk_option($dwdvm_dashb, "disable", "No");?>
                <?=mk_option($dwdvm_dashb, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting will enable a dashboard with data volume metrics for the primary network interface (as configured above) on your system's front page.</p>
    </blockquote>

    <dl>
        <dt>Show Data Volume Metrics in Footer:</dt>
        <dd>
            <select id="FOOTER" name="FOOTER" size="1">
                <?=mk_option($dwdvm_footer, "disable", "No");?>
                <?=mk_option($dwdvm_footer, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting will enable a footer with data volume metrics for the primary network interface (as configured above) on all of your system's pages.</p>
    </blockquote>

    <dl>
        <dt>Miniature Data Volume Reporting Time:</dt>
        <dd>
            <select id="FOOTERFORMAT" name="FOOTERFORMAT" size="1">
                <?=mk_option($dwdvm_footerformat, "5", "Last 5 Minutes");?>
                <?=mk_option($dwdvm_footerformat, "h", "Last Hour");?>
                <?=mk_option($dwdvm_footerformat, "d", "Last Day");?>
                <?=mk_option($dwdvm_footerformat, "m", "Last Month");?>
                <?=mk_option($dwdvm_footerformat, "y", "Last Year");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls how the miniature data volume metrics in the footer and dashboard are displayed.</p>
    </blockquote>

    <dl>
        <dt>General Data Volume Reporting Format:</dt>
        <dd>
            <select id="REPORT" name="REPORT" size="1">
                <?=mk_option($dwdvm_report, 'text', 'Textual Metrics');?>
                <?=mk_option($dwdvm_report, 'images', 'Image Metrics');?>
                <?=mk_option($dwdvm_report, 'both', 'Dual Metrics');?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls how the data volume metrics are displayed on this page.</p>
        <p>Not all versions of UNRAID include the required image generation libraries, so on some systems the image metrics may not show.</p>
    </blockquote>

    <dl>
        <dt>Custom Alarms Script Execution Frequency:</dt>
            <dd>
                <select id="CRONINT" name="CRONINT" size="1">
                    <?=mk_option($dwdvm_cronint, 'disable', 'Never');?>
                    <?=mk_option($dwdvm_cronint, '01min', 'Every 01 Minute(s)');?>
                    <?=mk_option($dwdvm_cronint, '15min', 'Every 15 Minute(s)');?>
                    <?=mk_option($dwdvm_cronint, '30min', 'Every 30 Minute(s)');?>
                    <?=mk_option($dwdvm_cronint, '45min', 'Every 45 Minute(s)');?>
                    <?=mk_option($dwdvm_cronint, '60min', 'Every 60 Minute(s)');?>
                </select>
            </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls how often the custom alarms script (editable below) is executed by the crontab.</p>
    </blockquote>

    <dl>
        <dt>Enable Volume Limit Exceeded Notifications:</dt>
        <dd>
            <select id="BADNOTIFY" name="BADNOTIFY" size="1">
                <?=mk_option($dwdvm_bad_notify, "disable", "No");?>
                <?=mk_option($dwdvm_bad_notify, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting will enable notifications when a certain data volume threshold has been exceeded on the primary network interface.</p>
    </blockquote>

    <dl>
        <dt>Enable Volume Limit Normal Again Notifications:</dt>
        <dd>
            <select id="GOODNOTIFY" name="GOODNOTIFY" size="1">
                <?=mk_option($dwdvm_good_notify, "disable", "No");?>
                <?=mk_option($dwdvm_good_notify, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting will enable notifications when the data limit is normal again (reset) on the primary network interface (enough time has passed).</p>
    </blockquote>

    <br><hr><br>

    <dl>
        <dt>Last <strong>Hour</strong> <strong><u>IN</u></strong>-bound Data Volume Threshold:</dt>
        <dd>
            <input type="text" class="narrow" id="HLIMITRX" name="HLIMITRX" maxlength="40" value="<?=$dwdvm_hlimit_rx;?>">
            <select id="HUNITRX" name="HUNITRX" size="1">
            <?=mk_option($dwdvm_hunit_rx, "B", "B");?>
            <?=mk_option($dwdvm_hunit_rx, "KB", "KB");?>
            <?=mk_option($dwdvm_hunit_rx, "MB", "MB");?>
            <?=mk_option($dwdvm_hunit_rx, "GB", "GB");?>
            <?=mk_option($dwdvm_hunit_rx, "TB", "TB");?>
            </select><em style="font-size:x-small">disable: -1</em>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls the last hour inbound data volume threshold on notifications, footer and dashboard (for the primary network interface).</p>
    </blockquote>

    <dl>
        <dt>Last <strong>Hour</strong> <strong><u>OUT</u></strong>-bound Data Volume Threshold:</dt>
        <dd>
            <input type="text" class="narrow" id="HLIMITTX" name="HLIMITTX" maxlength="40" value="<?=$dwdvm_hlimit_tx;?>">
            <select id="HUNITTX" name="HUNITTX" size="1">
            <?=mk_option($dwdvm_hunit_tx, "B", "B");?>
            <?=mk_option($dwdvm_hunit_tx, "KB", "KB");?>
            <?=mk_option($dwdvm_hunit_tx, "MB", "MB");?>
            <?=mk_option($dwdvm_hunit_tx, "GB", "GB");?>
            <?=mk_option($dwdvm_hunit_tx, "TB", "TB");?>
            </select><em style="font-size:x-small">disable: -1</em>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls the last hour outbound data volume threshold on notifications, footer and dashboard (for the primary network interface).</p>
    </blockquote>

    <dl>
        <dt>Last <strong>Day</strong> <strong><u>IN</u></strong>-bound Data Volume Threshold:</dt>
        <dd>
            <input type="text" class="narrow" id="DLIMITRX" name="DLIMITRX" maxlength="40" value="<?=$dwdvm_dlimit_rx;?>">
            <select id="DUNITRX" name="DUNITRX" size="1">
            <?=mk_option($dwdvm_dunit_rx, "B", "B");?>
            <?=mk_option($dwdvm_dunit_rx, "KB", "KB");?>
            <?=mk_option($dwdvm_dunit_rx, "MB", "MB");?>
            <?=mk_option($dwdvm_dunit_rx, "GB", "GB");?>
            <?=mk_option($dwdvm_dunit_rx, "TB", "TB");?>
            </select><em style="font-size:x-small">disable: -1</em>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls the last day inbound data volume threshold on notifications, footer and dashboard (for the primary network interface).</p>
    </blockquote>

    <dl>
        <dt>Last <strong>Day</strong> <strong><u>OUT</u></strong>-bound Data Volume Threshold:</dt>
        <dd>
            <input type="text" class="narrow" id="DLIMITTX" name="DLIMITTX" maxlength="40" value="<?=$dwdvm_dlimit_tx;?>">
            <select id="DUNITTX" name="DUNITTX" size="1">
            <?=mk_option($dwdvm_dunit_tx, "B", "B");?>
            <?=mk_option($dwdvm_dunit_tx, "KB", "KB");?>
            <?=mk_option($dwdvm_dunit_tx, "MB", "MB");?>
            <?=mk_option($dwdvm_dunit_tx, "GB", "GB");?>
            <?=mk_option($dwdvm_dunit_tx, "TB", "TB");?>
            </select><em style="font-size:x-small">disable: -1</em>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls the last day outbound data volume threshold on notifications, footer and dashboard (for the primary network interface).</p>
    </blockquote>

    <dl>
        <dt>Last <strong>Month</strong> <strong><u>IN</u></strong>-bound Data Volume Threshold:</dt>
        <dd>
            <input type="text" class="narrow" id="MLIMITRX" name="MLIMITRX" maxlength="40" value="<?=$dwdvm_mlimit_rx;?>">
            <select id="MUNITRX" name="MUNITRX" size="1">
            <?=mk_option($dwdvm_munit_rx, "B", "B");?>
            <?=mk_option($dwdvm_munit_rx, "KB", "KB");?>
            <?=mk_option($dwdvm_munit_rx, "MB", "MB");?>
            <?=mk_option($dwdvm_munit_rx, "GB", "GB");?>
            <?=mk_option($dwdvm_munit_rx, "TB", "TB");?>
            </select><em style="font-size:x-small">disable: -1</em>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls the last month inbound data volume threshold on notifications, footer and dashboard (for the primary network interface).</p>
    </blockquote>

    <dl>
        <dt>Last <strong>Month</strong> <strong><u>OUT</u></strong>-bound Data Volume Threshold:</dt>
        <dd>
            <input type="text" class="narrow" id="MLIMITTX" name="MLIMITTX" maxlength="40" value="<?=$dwdvm_mlimit_tx;?>">
            <select id="MUNITTX" name="MUNITTX" size="1">
            <?=mk_option($dwdvm_munit_tx, "B", "B");?>
            <?=mk_option($dwdvm_munit_tx, "KB", "KB");?>
            <?=mk_option($dwdvm_munit_tx, "MB", "MB");?>
            <?=mk_option($dwdvm_munit_tx, "GB", "GB");?>
            <?=mk_option($dwdvm_munit_tx, "TB", "TB");?>
            </select><em style="font-size:x-small">disable: -1</em>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls the last month outbound data volume threshold on notifications, footer and dashboard (for the primary network interface).</p>
    </blockquote>

    <dl>
        <dt>Last <strong>Year</strong> <strong><u>IN</u></strong>-bound Data Volume Threshold:</dt>
        <dd>
            <input type="text" class="narrow" id="YLIMITRX" name="YLIMITRX" maxlength="40" value="<?=$dwdvm_ylimit_rx;?>">
            <select id="YUNITRX" name="YUNITRX" size="1">
            <?=mk_option($dwdvm_yunit_rx, "B", "B");?>
            <?=mk_option($dwdvm_yunit_rx, "KB", "KB");?>
            <?=mk_option($dwdvm_yunit_rx, "MB", "MB");?>
            <?=mk_option($dwdvm_yunit_rx, "GB", "GB");?>
            <?=mk_option($dwdvm_yunit_rx, "TB", "TB");?>
            </select><em style="font-size:x-small">disable: -1</em>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls the last year inbound data volume threshold on notifications, footer and dashboard (for the primary network interface).</p>
    </blockquote>

    <dl>
        <dt>Last <strong>Year</strong> <strong><u>OUT</u></strong>-bound Data Volume Threshold:</dt>
        <dd>
            <input type="text" class="narrow" id="YLIMITTX" name="YLIMITTX" maxlength="40" value="<?=$dwdvm_ylimit_tx;?>">
            <select id="YUNITTX" name="YUNITTX" size="1">
            <?=mk_option($dwdvm_yunit_tx, "B", "B");?>
            <?=mk_option($dwdvm_yunit_tx, "KB", "KB");?>
            <?=mk_option($dwdvm_yunit_tx, "MB", "MB");?>
            <?=mk_option($dwdvm_yunit_tx, "GB", "GB");?>
            <?=mk_option($dwdvm_yunit_tx, "TB", "TB");?>
            </select><em style="font-size:x-small">disable: -1</em>
        </dd>
    </dl>

    <blockquote class="inline_help">
        <p>This setting controls the last year outbound data volume threshold on notifications, footer and dashboard (for the primary network interface).</p>
    </blockquote>

    <dl>
        <dt>
            <input id="DEFAULT" type="submit" name="#default" value="Default">
        </dt>
        <dd>
            <input type="submit" value="Apply"><input type="button" value="Done" onclick="done()">
        </dd>
    </dl>
</form>

<script src="<?=autov('/plugins/dwdvm/js/jquery.mask.min.js');?>"></script>

<script>
function checkRUNNING(){
   if ($('#SERVICE').val() === 'enable')
        $('#command').val('/usr/local/emhttp/plugins/dwdvm/scripts/start');
    else
        $('#command').val('/usr/local/emhttp/plugins/dwdvm/scripts/stop');
    if ("<?=$dwdvm_running;?>" == 1){
        $('.dwdvm-run').prop('disabled', true);
        $('#RESTART').prop('disabled', false);
    }else{
        $('.dwdvm-run').prop('disabled', false);
        $('#RESTART').prop('disabled', true);
    }
}
function Restart(){
    $('#command').val('/usr/local/emhttp/plugins/dwdvm/scripts/restart');
    $('#dwdvm-settings').submit();
}
function ResetConfig(){
    $('#command').val('');
    openBox('/usr/local/emhttp/plugins/dwdvm/scripts/resetconf', 'DVM Reset Config', 600, 600, true);
}
function ResetAll(){
    $('#command').val('');
    openBox('/usr/local/emhttp/plugins/dwdvm/scripts/resetall', 'DVM Reset All', 600, 600, true);
}
$(function() {

    $('form input:not([type="submit"])').keydown(function(e) {
        if (e.keyCode == 13) {
            e.preventDefault();
            return false;
        }
    });

    $('#btnApply').click(function(){
        $('#dwdvm-settings').submit();
    });

    $('#RESTART').click(Restart);

    if (typeof swal === "function") { 
        $('#RESETCONF').click(function(){ swal({title:"Are you sure?",text:"DVM configuration will be returned to the default state!",type:"warning",html:true,showCancelButton:true}, ResetConfig); });
        $('#RESETALL').click(function(){ swal({title:"Are you sure?",text:"DVM configuration and database will be returned to the default state!",type:"warning",html:true,showCancelButton:true}, ResetAll); });
    } else {
        $('#RESETCONF').click(ResetConfig);
        $('#RESETALL').click(ResetAll);
    }

    $('#SERVICE').change(checkRUNNING);

    checkRUNNING();

});
</script>
